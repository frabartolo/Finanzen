name: Automated Backup

on:
  schedule:
    # Täglich um 2 Uhr morgens
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup-database:
    runs-on: ubuntu-latest
    steps:
      - name: Backup Production Database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/finanzen
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql.gz"
            docker compose exec -T db pg_dump -U finanzen finanzen | gzip > "/opt/backups/$BACKUP_FILE"
            # Alte Backups löschen (älter als 30 Tage)
            find /opt/backups -name "backup_*.sql.gz" -mtime +30 -delete
            echo "Backup created: $BACKUP_FILE"

      - name: Backup to Remote Storage
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Optional: Backup zu S3, Backblaze oder ähnlichem
            if [ -n "${{ secrets.BACKUP_REMOTE_PATH }}" ]; then
              rsync -avz /opt/backups/ ${{ secrets.BACKUP_REMOTE_PATH }}
            fi
